<template>
    <!-- Style -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
    .effect-box {
        padding: 2px;
        margin-top: 12px;
        color: rgba(102, 102, 102, 0.5);
        border: 1px solid rgba(102, 102, 102, 0.5);
        background-color:rgba(0, 0, 0, 0);
    }
    .intensity {
        font-family: "Times New Roman", Times, serif;
        font-size: 20px;
        color: #ff4411;
    }
    </style>
    <!-- Box Effects -->
    <!-- <div class="container"> -->
        <div class="row">
            <div class="col-xs-12">
                <div class="col-xs-2 effect-box text-center">
                    Wind Effect<br> <span id="intensity-wind" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Vibrate Effect<br> <span id="intensity-vibration" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Light Effect<br> <span id="intensity-light" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Fog Effect<br> <span id="intensity-fog" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Temp Effect<br> <span id="intensity-temperature" class="intensity">-</span>
                </div>
                <div class="col-xs-2 effect-box text-center">
                    Water Spray <br> <span id="intensity-water-spray" class="intensity">-</span>
                </div>
                <div class="col-xs-12 effect-box text-center">
                    Scent <br> <span id="intensity-scent" class="intensity">-</span>
                </div>
            </div>
        </div>
    <!-- </div>   -->

</template>

<script>
    var thisDocument = document.currentScript.ownerDocument;
    document.addEventListener("DOMContentLoaded", function(event) {

        (function() {
            //var thisDocument = document.currentScript.ownerDocument;

            //Get the contents of the template (Polyfill use _currentScript)
            var template = thisDocument.querySelector('template');

            //Create a prototype for this component
            var vibrationEffect = Object.create(HTMLElement.prototype);
            var windEffect = Object.create(HTMLElement.prototype);
            var lightEffect = Object.create(HTMLElement.prototype);
            var fogEffect = Object.create(HTMLElement.prototype);
            var temperatureEffect = Object.create(HTMLElement.prototype);
            var waterSpray = Object.create(HTMLElement.prototype);
            var scentEffect = Object.create(HTMLElement.prototype);
            var conditionalEffect = Object.create(HTMLElement.prototype);
            var mulsemediaBox = Object.create(HTMLElement.prototype);

            /*BOX EFFECTS*/

            mulsemediaBox.createdCallback = function () {
                //Grab the contents of the template
                var clone = document.importNode(template.content, true);
                //Add the template contents to the Shadow DOM
                this.createShadowRoot().appendChild(clone);

                this.idBind = this.getAttribute('idBind');
                this.onStart = this.getAttribute('onStart');
            };

            /*List of the media*/
            var listMulsemediaBox = document.querySelectorAll('mulsemedia-box');

            /*Object Media representa a midia que contem efeitos MS*/
            var MulsemediaBox = function (element, list_effects, conditional_effects) {
                if (element) this.element = element;
                if (list_effects) this.list_effects = list_effects;
                if (conditional_effects) this.conditional_effects = conditional_effects;
            };

            MulsemediaBox.prototype.syncTime = function (video, effect){
                //get spans from shadowRoot
                var thisShadowRoot = effect.parentNode.shadowRoot;
                var textIntensity = thisShadowRoot.getElementById('intensity-'+effect.type);
                var currentTime = video.currentTime;
                var duration = (effect.endTime - video.currentTime) * 1000;
                var withinBounds = (currentTime >= effect.startTime) && (currentTime < effect.endTime);

                if (!isNaN(effect.fade) && effect.executing){

                    effect.fadeIntensity += effect.fade;
                    textIntensity.innerHTML = (effect.type === 'scent')
                                            ? effect.type_scent + " with " + (effect.fadeIntensity.toFixed(2)) + " intensity"
                                            : (effect.fadeIntensity.toFixed(2));
                }

                if (!video.paused){
                    if (withinBounds && !effect.executing){

                        if (effect.type === 'vibration') vibrate(duration);

                        textIntensity.innerHTML = (effect.type === 'scent')
                                                ? effect.type_scent + " with " + effect.intensity + " intensity"
                                                : effect.intensity;

                        effect.executing = true;
                    }

                    if(currentTime >= effect.endTime && effect.executing){
                        //console.log("effect "+effect.type+" with "+effect.intensity+" intensity finished");
                        effect.executing = false;
                        textIntensity.innerHTML = '-';
                        effect.fadeIntensity = effect.intensity; //zera fading
                        if (effect.type === 'vibration') vibrate(0);
                    }

                    if(currentTime <= effect.startTime && effect.executing){
                        //console.log("effect "+effect.type+" with "+effect.intensity+" intensity stoped");
                        effect.executing = false;
                        textIntensity.innerHTML = '-';
                        effect.fadeIntensity = effect.intensity; //zera fading
                        if (effect.type === 'vibration') vibrate(0);
                    }
                }
                else if(video.paused && effect.executing){
                    //console.log("effect "+effect.type+" with "+effect.intensity+" intensity paused");
                    effect.executing = false;
                    textIntensity.innerHTML = '-';
                    if (effect.type === 'vibration') vibrate(0);
                }
            };

            /*
              Funcao que verifica qual tipo de midia e seus atributos
              e Starta o time adequado
            */
            MulsemediaBox.prototype.startTimerListener = function(list) {
                var length = this.list_effects.length;
                var mulsemediaBox = this;
                var element = this.element;

                //console.log(list);

                if (element.tagName === 'MULSEMEDIA-BOX') {

                  var idBind = element.getAttribute('idBind');
                  var onStart = element.getAttribute('onStart');

                  elementBind = document.getElementById(idBind);

                  if (elementBind) {

                    // Video - onTimeUpdate
                    if (elementBind.tagName === 'VIDEO') {
                        elementBind.addEventListener("timeupdate", function () {
                           for (var i = 0; i < length; i++) {
                               mulsemediaBox.syncTime(elementBind, list[i]);
                           }
                        }, false);
                    }

                    // Img - onStart
                    if (elementBind.tagName === 'IMG') {

                      if (onStart) {
                        var type = document.getElementById(onStart);
                        if (type.tagName === 'BUTTON' || type.tagName === 'A'){
                          $(type).click(function () {
                            $.each(list, function () {
                              mulsemediaBox.runEffect(this);
                            });
                          });
                        }
                      }
                      else {
                        console.log("ERROR - Attribute onStart is undefined");
                      }

                    }

                  }
                  else {
                    console.log("ERROR - MulsemediaBox doesn't have an id");
                  }
                }
            };

            MulsemediaBox.prototype.runEffect = function (effect) {
                //var duration = effect.duration * 1000;
                var duration = (effect.endTime - effect.startTime) * 1000;
                var thisShadowRoot = (effect.parentNode.tagName === 'MULSEMEDIA-BOX') ?
                                        effect.parentNode.shadowRoot :
                                        effect.parentNode.parentNode.shadowRoot; // first parent is conditional-effect
                var textIntensity = thisShadowRoot.getElementById('intensity-'+effect.type);
                var timer;

                setTimeout(function () {
                    // StartEffect
                    effect.executing = true;
                    console.log('running '+effect.type);
                    if (effect.type === 'vibration') vibrate(duration);
                    if (!isNaN(effect.fade)){

                        timer = setInterval(function () {
                            effect.fadeIntensity += effect.fade;
                            textIntensity.innerHTML = (effect.type === 'scent')
                                                    ? effect.type_scent + " with " + (effect.fadeIntensity.toFixed(2)) + " intensity"
                                                    : (effect.fadeIntensity.toFixed(2));
                        },250);
                    }
                    else {
                        textIntensity.innerHTML = (effect.type === 'scent')
                            ? effect.type_scent + " with " + effect.intensity + " intensity"
                            : effect.intensity;
                    }

                },  effect.startTime*1000);

                if (!(effect.endTime === 'infinite')){
                    setTimeout(function () {
                        //Finish Effect
                        effect.executing = false;
                        effect.fadeIntensity = effect.intensity;
                        clearInterval(timer);
                        textIntensity.innerHTML = '-';
                    },  effect.endTime*1000);
                }
            }

            MulsemediaBox.prototype.verifyConditionalEffect = function () {

             var answer = ['1','4','4','4','3'];
             var mulsemediaBox = this;
             var listService = [];
             var conditionalClass = $('conditional-effect[service="classService"]');

             $(conditionalClass).on("responseClassService", function (event, response) {
               if (parseFloat(this.ifReturn) === response) {
                 mulsemediaBox.startTimerListener($(this).children());
               }
             });



             $.each(mulsemediaBox.conditional_effects, function () {
               var service = this.getAttribute('service');
               var conditionEffect = this;

               // Verifica se ja solicitou o serviço, para evitar recalculos
               if (listService.indexOf(service) === -1) {
                 listService.push(service);

                 if (service === 'classService') {
                   //var percentualResult = 0;
                   var socket = io('http://localhost:3000');
                   connectClassService(socket, 'getResult', answer, conditionalClass);
                 }
                 else if (service === 'dealService'){}

               }

             });
           };

            for (var i = 0; i < listMulsemediaBox.length; i++){
              var aux = new MulsemediaBox(listMulsemediaBox[i],
                                    $(listMulsemediaBox[i]).children().not('conditional-effect'),
                                    $(listMulsemediaBox[i]).children('conditional-effect'));

              aux.startTimerListener(aux.list_effects);

              if (aux.conditional_effects.length) {
                aux.verifyConditionalEffect();
              }
            }


            function connectClassService(socket, message, parameters, element) {
              // Request questions
            	socket.on('connect', function(){
                console.log("conectado!");
            		socket.emit(message, parameters);
            	});

              // Returned of the server
              socket.on('results', function(results){
                  var percentualResult = 0;
                  for (var i = 0; i < results.length; i++) {
                    if (results[i]) {
                      percentualResult += (100 / results.length);
                    }
                  }
                  socket.emit('end');
                  // Quando receber resposta do servidor, dispara um evento
                  $(element).trigger("responseClassService", [percentualResult]);

              });
            }

            /*EFFECTS*/

            /*** VIBRATION EFFECT ***/

            //Propertys
            vibrationEffect.type = "vibration";
            vibrationEffect.intensity = 0;
            vibrationEffect.startTime = 0;
            vibrationEffect.endTime = 0;
            vibrationEffect.executing = false;

            //Register a createdCallback
            vibrationEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** WIND EFFECT ***/

            //Propertys
            windEffect.type = "wind";
            windEffect.intensity = 0;
            windEffect.startTime = 0;
            windEffect.endTime = 0;
            windEffect.executing = false;

            //Register a createdCallback
            windEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** Light EFFECT ***/

            //Propertys
            lightEffect.type = "light";
            lightEffect.intensity = 0;
            lightEffect.startTime = 0;
            lightEffect.endTime = 0;
            lightEffect.executing = false;

            //Register a createdCallback
            lightEffect.createdCallback = function() {

                ///Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** Fog EFFECT ***/

            //Propertys
            fogEffect.type = "fog";
            fogEffect.intensity = 0;
            fogEffect.startTime = 0;
            fogEffect.endTime = 0;
            fogEffect.executing = false;

            //Register a createdCallback
            fogEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** Temperature EFFECT ***/

            //Propertys
            temperatureEffect.type = "temperature";
            temperatureEffect.intensity = 0;
            temperatureEffect.startTime = 0;
            temperatureEffect.endTime = 0;
            temperatureEffect.executing = false;
            //temperatureEffect.fade = false;

            //Register a createdCallback
            temperatureEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /* WATER SPRAY */
            //Propertys
            waterSpray.type = "water-spray";
            waterSpray.intensity = 0;
            waterSpray.startTime = 0;
            waterSpray.endTime = 0;
            waterSpray.executing = false;

            //Register a createdCallback
            waterSpray.createdCallback = function() {
                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /* SCENT EFFECT */
            //Propertys
            scentEffect.type = "scent";
            scentEffect.intensity = 0;
            scentEffect.startTime = 0;
            scentEffect.endTime = 0;
            scentEffect.executing = false;

            //Register a createdCallback
            scentEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
                this.type_scent = this.getAttribute('type_scent');
            };

            /* CONDITIONAL EFFECT */
            // Register a createdCallback
            conditionalEffect.createdCallback = function () {

              // Get Tag Attributes
              this.service = this.getAttribute('service');
              this.ifReturn = this.getAttribute('ifReturn');

            };


            /*** Register the elements with the document (thatDoc) ***/
            document.registerElement('vibration-effect', {prototype: vibrationEffect});
            document.registerElement('wind-effect', {prototype: windEffect});
            document.registerElement('light-effect', {prototype: lightEffect});
            document.registerElement('fog-effect', {prototype: fogEffect});
            document.registerElement('temperature-effect', {prototype: temperatureEffect});
            document.registerElement('water-spray', {prototype: waterSpray});
            document.registerElement('scent-effect', {prototype: scentEffect});
            document.registerElement('conditional-effect', {prototype: conditionalEffect});
            document.registerElement('mulsemedia-box', {prototype: mulsemediaBox});

            /*** support functions ***/

            function vibrate(duration) {
                if(!(window.navigator.vibrate(duration)))
                    console.log('Not supported by browser');
            }


            //this will start from the first child of the current element's and get all the siblings
            // function getAllSiblings(elem, filter) {
            //     var sibs = [];
            //     var patt = new RegExp("WATER-SPRAY|((VIBRATION|WIND|TEMPERATURE|FOG|LIGHT|SCENT|CONDITIONAL)-EFFECT$)");
            //     /*Video -> childrens  /  img -> siblings*/
            //     if (elem.tagName === 'VIDEO' || elem.tagName === 'MULSEMEDIA-BOX'){
            //         elem = elem.firstChild;
            //     }
            //
            //     if (elem !== null){
            //         do {
            //             if (elem.nodeType === 3) continue; // text node
            //             if ((!filter || filter(elem)) && patt.test(elem.tagName)) sibs.push(elem);
            //         } while (elem = elem.nextSibling)
            //     }
            //     return sibs;
            // }

        }());

    });



</script>
