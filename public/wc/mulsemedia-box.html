<template>
    <!-- Style -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
    .effect-box {
        padding: 2px;
        margin-top: 12px;
        color: rgba(102, 102, 102, 0.5);
        border: 1px solid rgba(102, 102, 102, 0.5);
        background-color:rgba(0, 0, 0, 0);
    }
    .intensity {
        font-family: "Times New Roman", Times, serif;
        font-size: 20px;
        color: #ff4411;
    }
    </style>
    <!-- Box Effects -->
    <!-- <div class="container"> -->
        <div class="row">
            <div class="col-xs-12">
                <div class="col-xs-2 effect-box text-center">
                    Wind Effect<br> <span id="intensity-wind" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Vibrate Effect<br> <span id="intensity-vibration" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Light Effect<br> <span id="intensity-light" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Fog Effect<br> <span id="intensity-fog" class="intensity">-</span>
                </div>

                <div class="col-xs-2 effect-box text-center">
                    Temp Effect<br> <span id="intensity-temperature" class="intensity">-</span>
                </div>
                <div class="col-xs-2 effect-box text-center">
                    Water Spray <br> <span id="intensity-water-spray" class="intensity">-</span>
                </div>
                <div class="col-xs-12 effect-box text-center">
                    Scent <br> <span id="intensity-scent" class="intensity">-</span>
                </div>
            </div>
        </div>
    <!-- </div>   -->

</template>

<script>
    var thisDocument = document.currentScript.ownerDocument;
    document.addEventListener("DOMContentLoaded", function(event) {

        (function() {
            //var thisDocument = document.currentScript.ownerDocument;

            //Get the contents of the template (Polyfill use _currentScript)
            var template = thisDocument.querySelector('template');

            //Create a prototype for this component
            var vibrationEffect = Object.create(HTMLElement.prototype);
            var windEffect = Object.create(HTMLElement.prototype);
            var lightEffect = Object.create(HTMLElement.prototype);
            var fogEffect = Object.create(HTMLElement.prototype);
            var temperatureEffect = Object.create(HTMLElement.prototype);
            var waterSpray = Object.create(HTMLElement.prototype);
            var scentEffect = Object.create(HTMLElement.prototype);
            var conditionalEffect = Object.create(HTMLElement.prototype);
            var mulsemediaBox = Object.create(HTMLElement.prototype);

            /*BOX EFFECTS*/

            mulsemediaBox.createdCallback = function () {
                //Grab the contents of the template
                var clone = document.importNode(template.content, true);
                //Add the template contents to the Shadow DOM
                this.createShadowRoot().appendChild(clone);

                this.idBind = this.getAttribute('idBind');
                this.onClickStart = this.getAttribute('onClickStart');
            };

            /*EFFECTS*/

            /*** VIBRATION EFFECT ***/

            //Propertys
            vibrationEffect.type = "vibration";
            vibrationEffect.intensity = 0;
            vibrationEffect.startTime = 0;
            vibrationEffect.endTime = 0;
            vibrationEffect.executing = false;

            //Register a createdCallback
            vibrationEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** WIND EFFECT ***/

            //Propertys
            windEffect.type = "wind";
            windEffect.intensity = 0;
            windEffect.startTime = 0;
            windEffect.endTime = 0;
            windEffect.executing = false;

            //Register a createdCallback
            windEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** Light EFFECT ***/

            //Propertys
            lightEffect.type = "light";
            lightEffect.intensity = 0;
            lightEffect.startTime = 0;
            lightEffect.endTime = 0;
            lightEffect.executing = false;

            //Register a createdCallback
            lightEffect.createdCallback = function() {

                ///Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** Fog EFFECT ***/

            //Propertys
            fogEffect.type = "fog";
            fogEffect.intensity = 0;
            fogEffect.startTime = 0;
            fogEffect.endTime = 0;
            fogEffect.executing = false;

            //Register a createdCallback
            fogEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /*** Temperature EFFECT ***/

            //Propertys
            temperatureEffect.type = "temperature";
            temperatureEffect.intensity = 0;
            temperatureEffect.startTime = 0;
            temperatureEffect.endTime = 0;
            temperatureEffect.executing = false;
            //temperatureEffect.fade = false;

            //Register a createdCallback
            temperatureEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /* WATER SPRAY */
            //Propertys
            waterSpray.type = "water-spray";
            waterSpray.intensity = 0;
            waterSpray.startTime = 0;
            waterSpray.endTime = 0;
            waterSpray.executing = false;

            //Register a createdCallback
            waterSpray.createdCallback = function() {
                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
            };

            /* SCENT EFFECT */
            //Propertys
            scentEffect.type = "scent";
            scentEffect.intensity = 0;
            scentEffect.startTime = 0;
            scentEffect.endTime = 0;
            scentEffect.executing = false;

            //Register a createdCallback
            scentEffect.createdCallback = function() {

                //Get Tag Attributes
                this.intensity = parseFloat(this.getAttribute('intensity'));
                this.startTime = this.getAttribute('startTime');
                this.endTime = this.getAttribute('endTime');
                this.fade = parseFloat(this.getAttribute('fade'));
                this.fadeIntensity = parseFloat(this.intensity);
                this.type_scent = this.getAttribute('type_scent');
            };

            /* CONDITIONAL EFFECT */
            // Register a createdCallback
            conditionalEffect.createdCallback = function () {

              // Get Tag Attributes
              this.service = this.getAttribute('service');
              this.ifReturn = this.getAttribute('ifReturn');
              this.in = this.getAttribute('in');
              this.op = this.getAttribute('op');

            };


            /*** Register the elements with the document (thatDoc) ***/
            document.registerElement('vibration-effect', {prototype: vibrationEffect});
            document.registerElement('wind-effect', {prototype: windEffect});
            document.registerElement('light-effect', {prototype: lightEffect});
            document.registerElement('fog-effect', {prototype: fogEffect});
            document.registerElement('temperature-effect', {prototype: temperatureEffect});
            document.registerElement('water-spray', {prototype: waterSpray});
            document.registerElement('scent-effect', {prototype: scentEffect});
            document.registerElement('conditional-effect', {prototype: conditionalEffect});
            document.registerElement('mulsemedia-box', {prototype: mulsemediaBox});

            /*List of the media*/
            var listMulsemediaBox = document.querySelectorAll('mulsemedia-box');

            /*Object Media representa a midia que contem efeitos MS*/
            var MulsemediaBox = function (element, list_effects, conditional_effects) {
                if (element) this.element = element;
                if (list_effects) this.list_effects = list_effects;
                if (conditional_effects) this.conditional_effects = conditional_effects;
            };

            /*
            startTimerListener():
              Funcao que verifica qual tipo de midia e seus atributos
              e Starta o time adequado. Ela pode chamar:
                syncTime() -> Caso a midia seja video/audio, para
                                        sincronizar com a timeline
                runEffect() -> Caso a midia seja imagem/texto/...
            */
            MulsemediaBox.prototype.startTimerListener = function(list) {
                var length = this.list_effects.length;
                var mulsemediaBox = this;
                var element = this.element;
                var idBind = element.getAttribute('idBind');
                var onClickStart = element.getAttribute('onClickStart');

                /*
                  Opções de atributos:
                  idBind="" onClickStart="" -> starta os efeitos assim que renderizar a pagina
                  idBind="idVideo" -> starta os efeitos de acordo com o tempo do video (USO OBRIGATORIO PARA VIDEOS)
                  idBind="id" onClickStart="idElement" -> starta os efeitos assim que clicar no elemento
                  idBind="id" onClickStart="" -> starta os efeitos assim que renderizar a pagina
                */
                  var elementBind = document.getElementById(idBind);

                  if (elementBind) {

                    // Video - onTimeUpdate
                    if (elementBind.tagName === 'VIDEO') {
                        elementBind.addEventListener("timeupdate", function () {
                           for (var i = 0; i < length; i++) {
                               mulsemediaBox.syncTime(elementBind, list[i]);
                           }
                        }, false);
                    }

                    // especificou evento de click
                    else if (onClickStart) {
                      var type = document.getElementById(onClickStart);
                      if (type){
                        $(type).click(function () {
                          $.each(list, function () {
                            mulsemediaBox.runEffect(this);
                          });
                        });
                      }
                    }

                    else {
                      $.each(list, function () {
                        mulsemediaBox.runEffect(this);
                      });
                    }

                  }
                  // Caso onde nao especificou o idBind
                  else {
                    // especificou evento de click
                    if (onClickStart) {
                      var type = document.getElementById(onClickStart);
                      if (type){
                        $(type).click(function () {
                          $.each(list, function () {
                            mulsemediaBox.runEffect(this);
                          });
                        });
                      }
                    }
                    else {
                      $.each(list, function () {
                        mulsemediaBox.runEffect(this);
                      });
                    }

                  }
            };

            MulsemediaBox.prototype.syncTime = function (video, effect){
                //get spans from shadowRoot
                var thisShadowRoot = effect.parentNode.shadowRoot;
                var textIntensity = thisShadowRoot.getElementById('intensity-'+effect.type);
                var currentTime = video.currentTime;
                var duration = (effect.endTime - video.currentTime) * 1000;
                var withinBounds = (currentTime >= effect.startTime) && (currentTime < effect.endTime);

                if (!isNaN(effect.fade) && effect.executing){

                    effect.fadeIntensity += effect.fade;
                    textIntensity.innerHTML = (effect.type === 'scent')
                                            ? effect.type_scent + " with " + (effect.fadeIntensity.toFixed(2)) + " intensity"
                                            : (effect.fadeIntensity.toFixed(2));
                }

                if (!video.paused){
                    if (withinBounds && !effect.executing){

                        if (effect.type === 'vibration') vibrate(duration);

                        textIntensity.innerHTML = (effect.type === 'scent')
                                                ? effect.type_scent + " with " + effect.intensity + " intensity"
                                                : effect.intensity;

                        effect.executing = true;
                    }

                    if(currentTime >= effect.endTime && effect.executing){
                        //console.log("effect "+effect.type+" with "+effect.intensity+" intensity finished");
                        effect.executing = false;
                        textIntensity.innerHTML = '-';
                        effect.fadeIntensity = effect.intensity; //zera fading
                        if (effect.type === 'vibration') vibrate(0);
                    }

                    if(currentTime <= effect.startTime && effect.executing){
                        //console.log("effect "+effect.type+" with "+effect.intensity+" intensity stoped");
                        effect.executing = false;
                        textIntensity.innerHTML = '-';
                        effect.fadeIntensity = effect.intensity; //zera fading
                        if (effect.type === 'vibration') vibrate(0);
                    }
                }
                else if(video.paused && effect.executing){
                    //console.log("effect "+effect.type+" with "+effect.intensity+" intensity paused");
                    effect.executing = false;
                    textIntensity.innerHTML = '-';
                    if (effect.type === 'vibration') vibrate(0);
                }
            };

            MulsemediaBox.prototype.runEffect = function (effect) {
                //var duration = effect.duration * 1000;
                var duration = (effect.endTime - effect.startTime) * 1000;
                var thisShadowRoot = (effect.parentNode.tagName === 'MULSEMEDIA-BOX') ?
                                        effect.parentNode.shadowRoot :
                                        effect.parentNode.parentNode.shadowRoot; // first parent is conditional-effect

                var textIntensity = thisShadowRoot.getElementById('intensity-'+effect.type);
                var timer;

                setTimeout(function () {
                    // StartEffect
                    effect.executing = true;
                    //console.log('running '+effect.type);
                    if (effect.type === 'vibration') vibrate(duration);
                    if (!isNaN(effect.fade)){

                        timer = setInterval(function () {
                            effect.fadeIntensity += effect.fade;
                            textIntensity.innerHTML = (effect.type === 'scent')
                                                    ? effect.type_scent + " with " + (effect.fadeIntensity.toFixed(2)) + " intensity"
                                                    : (effect.fadeIntensity.toFixed(2));
                        },250);
                    }
                    else {
                        textIntensity.innerHTML = (effect.type === 'scent')
                            ? effect.type_scent + " with " + effect.intensity + " intensity"
                            : effect.intensity;
                    }

                },  effect.startTime*1000);

                if (!(effect.endTime === 'infinite')){
                    setTimeout(function () {
                        //Finish Effect
                        effect.executing = false;
                        effect.fadeIntensity = effect.intensity;
                        clearInterval(timer);
                        textIntensity.innerHTML = '-';
                    },  effect.endTime*1000);
                }
            }

            MulsemediaBox.prototype.verifyConditionalEffect = function () {
               var mulsemediaBox = this;
               var listService = [];
               var conditionalClass = [];
               var conditionalDeal = [];
               /* Preeche apenas com as condicoes dos servicos especificos */
               $.each(mulsemediaBox.conditional_effects, function () {
                 if (this.service === 'classService') {
                   conditionalClass.push(this);
                 }
                 else if (this.service === 'dealService') {
                   conditionalDeal.push(this)
                 }
               });

               //start consulta ao servico com o botao
               if (this.element.onClickStart) {
                 $('#'+this.element.onClickStart).click(function () {
                     if (conditionalClass.length) {
                       var socket = io.connect('http://localhost:3000');
                       $.each(conditionalClass, function () {
                         connectClassService(socket, 'getResult', $('#'+this.in).val(), this);
                       });
                     }

                     if (conditionalDeal.length) {
                      var socket = io.connect('http://localhost:3030');
                      $.each(conditionalDeal, function () {
                        connectDealService(socket, 'validateCard', $('#'+this.in).val(), this);
                      });
                     }
                 });
               }
               else { // start consulta ao servico ao renderizar
                 console.log('a');
                 if (conditionalClass.length) {
                   var socket = io.connect('http://localhost:3000');
                   $.each(conditionalClass, function () {
                     connectClassService(socket, 'getResult', $('#'+this.in).val(), this);
                   });
                 }

                 if (conditionalDeal.length) {
                  var socket = io.connect('http://localhost:3030');
                  $.each(conditionalDeal, function () {
                    connectDealService(socket, 'validateCard', $('#'+this.in).val(), this);
                  });
                 }
               }

               //  Quando receber uma resposta do servidor, captura o evento
               $(conditionalClass).on("responseClassService", function (event, response) {
                 console.log(response);
                 if (computeCondition(response, parseFloat(this.ifReturn), this.op)) {
                   console.log('Accepted condition!');
                   if (mulsemediaBox.element.onClickStart) {
                     $(this).children().each(function () {
                       mulsemediaBox.runEffect(this);
                     });
                   }
                   else {
                    mulsemediaBox.startTimerListener($(this).children());
                   }
                 }
                 else {
                   console.log('Rejected condition!');
                 }
               });

               $(conditionalDeal).on("responseDealService", function (event, response) {
                 //console.log(this);
                 if (computeCondition(response, parseFloat(this.ifReturn), this.op)) {
                   console.log('Accepted condition!');
                   if (mulsemediaBox.element.onClickStart) { //evitar dois cliques
                     $(this).children().each(function () {
                       mulsemediaBox.runEffect(this);
                     });
                   }
                   else {
                     mulsemediaBox.startTimerListener($(this).children());
                   }
                 }
                 else {
                   console.log('Rejected condition!');
                 }
               });
           }; //verifyConditionalEffect



           /******* Start MulsemediaBox *******/
            startMulsemediaBox();
            function startMulsemediaBox() {
              for (var i = 0; i < listMulsemediaBox.length; i++){
                var aux = new MulsemediaBox(listMulsemediaBox[i],
                                      $(listMulsemediaBox[i]).children().not('conditional-effect'),
                                      $(listMulsemediaBox[i]).children('conditional-effect'));

                aux.startTimerListener(aux.list_effects);

                if (aux.conditional_effects.length) {
                  aux.verifyConditionalEffect();
                }
              }
            }

            /* HELPER FUNCTIONS BEGIN*/

            function connectClassService(socket, message, parameters, element) {
              // Request questions
            	socket.on('connect', function(){
                console.log("conectado!");
                socket.emit(message, parameters);
            	});
              // Returned of the server

              socket.on('results', function(results){
                  socket.disconnect();
                  console.log("desconectado!");
                  var percentualResult = 0;
                  for (var i = 0; i < results.length; i++) {
                    if (results[i]) {
                      percentualResult += (100 / results.length);
                    }
                  }
                  // Quando receber resposta do servidor, dispara um evento
                  $(element).trigger("responseClassService", [percentualResult]);

              });
            }

            function connectDealService(socket, message, parameters, element, response) {
              // Request questions
            	socket.on('connect', function(){
                console.log("conectado!");
            		socket.emit(message, parameters);
            	});

              // Returned of the server
              socket.on('resultValidation', function(results){
                  socket.disconnect();
                  // Quando receber resposta do servidor, dispara um evento
                  $(element).trigger("responseDealService", [results]);
              });
            }

            function vibrate(duration) {
                if(!(window.navigator.vibrate(duration)))
                    console.log('Not supported by browser');
            }

            function computeCondition(nServe, nCondition, op) {
              switch (op) {
                case '=':
                  return (nServe === nCondition);
                case '>':
                  return (nServe > nCondition);
                case '<':
                  return (nServe < nCondition);
                case '>=':
                  return (nServe >= nCondition);
                case '<=':
                  return (nServe <= nCondition);
                case '!=':
                  return (nServe !== nCondition);
                default:
                  return null;
              }
            }


            //this will start from the first child of the current element's and get all the siblings
            // function getAllSiblings(elem, filter) {
            //     var sibs = [];
            //     var patt = new RegExp("WATER-SPRAY|((VIBRATION|WIND|TEMPERATURE|FOG|LIGHT|SCENT|CONDITIONAL)-EFFECT$)");
            //     /*Video -> childrens  /  img -> siblings*/
            //     if (elem.tagName === 'VIDEO' || elem.tagName === 'MULSEMEDIA-BOX'){
            //         elem = elem.firstChild;
            //     }
            //
            //     if (elem !== null){
            //         do {
            //             if (elem.nodeType === 3) continue; // text node
            //             if ((!filter || filter(elem)) && patt.test(elem.tagName)) sibs.push(elem);
            //         } while (elem = elem.nextSibling)
            //     }
            //     return sibs;
            // }

        }());

    });



</script>
